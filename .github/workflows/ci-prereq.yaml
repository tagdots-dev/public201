---
name: CI-prerequisites
on:  # yamllint disable-line rule:truthy
  push:
    branches:
      - main
      - test-*
  pull_request:
    branches:
      - main

jobs:
  tflint:
    strategy:
      matrix:
        os: [ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
    - name: Create Cache plugin dir
      run: mkdir -p ~/.tflint.d/plugins
    - name: Cache plugin dir
      uses: actions/cache@v4
      with:
        path: ~/.tflint.d/plugins
        key: ${{ matrix.os }}-tflint
    - name: Setup TFLint
      uses: terraform-linters/setup-tflint@v4
      with:
        tflint_version: v0.55.1
    - name: Show version
      run: tflint --version
    - name: Init TFLint
      run: tflint --init
      env:
        # https://github.com/terraform-linters/tflint/blob/master/docs/user-guide/plugins.md#avoiding-rate-limiting
        # Summary: TFLint calls the GitHub API to get release metadata
        GITHUB_TOKEN: ${{ github.token }}
    - name: Run TFLint
      run: tflint --recursive -f sarif

  yaml-lint:
    strategy:
      matrix:
        os: [ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
    - name: yaml-lint
      uses: ibiqlik/action-yamllint@v3
      with:
        config_file: .github/config/yamllint-cfg.yaml
    - name: Show version
      run: yamllint --version

  checkov:
    strategy:
      matrix:
        os: [ubuntu-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      - name: Checkov GitHub Action
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          skip_results_upload: "true"
          enable_secrets_scan_all_files: "true"
          skip_check: CKV_GIT_1,CKV_GIT_3,CKV_GIT_5,CKV2_GIT_1,CKV2_GHA_1,CKV_DOCKER_2,CKV_DOCKER_3
          quiet: true
          # Skip Check
          # ID           Description
          # CKV_GIT_1    - Ensure GitHub repository is Private
          # CKV_GIT_3    - GitHub Repository defined in Terraform doesnâ€™t have vulnerability alerts enabled
          # CKV_GIT_5    - GitHub pull requests should require at least 2 approvals
          # CKV2_GIT_1   - Ensure each Repository has branch protection associated
          # CKV2_GHA_1   - Ensure top-level permissions are not set to write-all
          # CKV_DOCKER_2 - Ensure that HEALTHCHECK instructions have been added to container images
          # CKV_DOCKER_3 - Ensure that a user for the container has been created

  upgrade:
    uses: browniebroke/github-actions/.github/workflows/pre-commit-autoupdate.yml@v1
    secrets:
      gh_pat: ${{ secrets.GITHUB_TOKEN }}
    with:
      # Inputs listed with their default (all optional)
      config_path: ".pre-commit-config.yaml"  # path is relative to repository root
      python_version: "3.11"
      branch_name: "update/pre-commit-hooks"
      pull_request_title: "chore(deps): upgrade dependencies"
      commit_message: "chore(deps): upgrade dependencies"
